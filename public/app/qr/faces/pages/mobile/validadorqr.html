<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Validador QR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

    <!-- OJO: ruta absoluta, para que funcione desde /app/qr/... -->
    <link rel="stylesheet" href="/css/sat-style.css">
</head>
<body>

<div class="sat-header">
    <img src="/img/header-sat.png" alt="Hacienda SAT">
</div>
    
<div class="page-wrapper">

    <!-- BARRA SUPERIOR RFC -->
    <div class="info-bar">
        El RFC: <span id="rfc"></span>, tiene asociada la siguiente informaci√≥n.
    </div>

    <!-- PANEL 1: DATOS DE IDENTIFICACI√ìN -->
    <section class="panel">
        <div class="panel-header">
            Datos de Identificaci√≥n
        </div>
        <div class="panel-body">
            <table class="data-table">
                <tr>
                    <td class="label"><span class="strong-right">CURP:</span></td>
                    <td class="value" id="curp"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Nombre:</span></td>
                    <td class="value" id="nombre"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Apellido Paterno:</span></td>
                    <td class="value" id="apellido_paterno"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Apellido Materno:</span></td>
                    <td class="value" id="apellido_materno"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Fecha Nacimiento:</span></td>
                    <td class="value" id="fecha_nacimiento"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Fecha de Inicio de operaciones:</span></td>
                    <td class="value" id="fecha_inicio_operaciones"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Situaci√≥n del contribuyente:</span></td>
                    <td class="value" id="situacion_contribuyente"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Fecha del √∫ltimo cambio de situaci√≥n:</span></td>
                    <td class="value" id="fecha_ultimo_cambio"></td>
                </tr>
            </table>
        </div>
    </section>

    <!-- PANEL 2: DATOS DE UBICACI√ìN -->
    <section class="panel">
        <div class="panel-header">
            Datos de Ubicaci√≥n (domicilio fiscal, vigente)
        </div>
        <div class="panel-body">
            <table class="data-table">
                <tr>
                    <td class="label"><span class="strong-right">Entidad Federativa:</span></td>
                    <td class="value" id="entidad"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Municipio o delegaci√≥n:</span></td>
                    <td class="value" id="municipio"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Colonia:</span></td>
                    <td class="value" id="colonia"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Tipo de vialidad:</span></td>
                    <td class="value" id="tipo_vialidad"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Nombre de la vialidad:</span></td>
                    <td class="value" id="nombre_vialidad"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">N√∫mero exterior:</span></td>
                    <td class="value" id="numero_exterior"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">N√∫mero interior:</span></td>
                    <td class="value" id="numero_interior"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">CP:</span></td>
                    <td class="value" id="cp"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Correo electr√≥nico:</span></td>
                    <td class="value" id="correo"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">AL:</span></td>
                    <td class="value" id="al"></td>
                </tr>
            </table>
        </div>
    </section>

    <!-- PANEL 3: CARACTER√çSTICAS FISCALES -->
    <section class="panel">
        <div class="panel-header">
            Caracter√≠sticas fiscales (vigente)
        </div>
        <div class="panel-body">
            <table class="data-table">
                <tr>
                    <td class="label"><span class="strong-right">R√©gimen:</span></td>
                    <td class="value" id="regimen"></td>
                </tr>
                <tr>
                    <td class="label"><span class="strong-right">Fecha de alta:</span></td>
                    <td class="value" id="fecha_alta"></td>
                </tr>
            </table>
        </div>
    </section>

</div>

<script>
  // 1) Leer par√°metros D1, D2, D3
  const params = new URLSearchParams(window.location.search);
  const D1 = params.get("D1");
  const D2 = params.get("D2");
  const D3 = params.get("D3"); // idCIF_RFC

  if (D1 !== "10" || D2 !== "1" || !D3) {
    document.body.innerHTML = "<h2>QR inv√°lido</h2>";
    throw new Error("Par√°metros inv√°lidos");
  }

  const set = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value || "";
  };

  const pintar = (persona) => {
    set("rfc", persona.rfc);
    set("curp", persona.curp);
    set("nombre", persona.nombre);
    set("apellido_paterno", persona.apellido_paterno);
    set("apellido_materno", persona.apellido_materno);
    set("fecha_nacimiento", persona.fecha_nacimiento);
    set("fecha_inicio_operaciones", persona.fecha_inicio_operaciones);
    set("situacion_contribuyente", persona.situacion_contribuyente);
    set("fecha_ultimo_cambio", persona.fecha_ultimo_cambio);

    set("entidad", persona.entidad);
    set("municipio", persona.municipio);
    set("colonia", persona.colonia);
    set("tipo_vialidad", persona.tipo_vialidad);
    set("nombre_vialidad", persona.nombre_vialidad);
    set("numero_exterior", persona.numero_exterior);
    set("numero_interior", persona.numero_interior);
    set("cp", persona.cp);
    set("correo", persona.correo || "");
    set("al", persona.al || "");

    set("regimen", persona.regimen);
    set("fecha_alta", persona.fecha_alta);
  };

  // Normaliza para el fallback al JSON grande
  const normalizarClave = (s) => (s || "").trim().toUpperCase();

  // ‚úÖ 2) Nuevo esquema: un archivo por persona
  const PERSONA_URL = `https://raw.githubusercontent.com/edgcsan77/validacion-sat/main/public/data/personas/${encodeURIComponent(D3)}.json`;

  // üîÅ Fallback (compatibilidad): JSON grande
  const PERSONAS_URL = "https://raw.githubusercontent.com/edgcsan77/validacion-sat/main/public/data/personas.json";

  // helper: fetch json con buen manejo de errores
  const fetchJson = async (url) => {
    const r = await fetch(`${url}?ts=${Date.now()}`, { cache: "no-store" });
    if (!r.ok) {
      const txt = await r.text().catch(() => "");
      const err = new Error(`HTTP ${r.status}`);
      err.status = r.status;
      err.head = (txt || "").slice(0, 120);
      throw err;
    }
    return r.json();
  };

  (async () => {
    try {
      // 1) intenta archivo individual
      const persona = await fetchJson(PERSONA_URL);
      pintar(persona);
      return;
    } catch (e1) {
      // si no existe (404), cae al grande
      if (e1 && e1.status !== 404) {
        console.error("Error cargando persona individual:", e1, e1.head || "");
      }
    }

    try {
      const db = await fetchJson(PERSONAS_URL);
      const d3Norm = normalizarClave(D3);
      const key = Object.keys(db).find(k => normalizarClave(k) === d3Norm);

      if (!key) {
        document.body.innerHTML = "<h2>No se encontr√≥ informaci√≥n para este c√≥digo.</h2>";
        return;
      }
      pintar(db[key]);
    } catch (e2) {
      console.error("Error cargando JSON grande:", e2, e2.head || "");
      document.body.innerHTML = "<h2>Error cargando datos de validaci√≥n.</h2>";
    }
  })();
</script>

</body>
</html>
